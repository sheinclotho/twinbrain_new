# TwinBrain V5 配置文件
# ===================

# 数据配置
data:
  # 数据根目录 - 修改为你的数据路径
  root_dir: "F:/twinbrain_v3/test_file3"
  
  # 要处理的模态
  modalities: ["eeg", "fmri"]
  
  # 任务名称列表 (null = 自动发现每个被试下所有任务; [] = 不过滤; ["rest","wm"] = 指定任务)
  # 每个 (被试, 任务) 组合生成一个图样本，多任务可显著增加训练数据量。
  tasks: null

  # task: (已弃用，请改用 tasks) 单任务名称；若 tasks 未设置则作为回退。
  task: null

  # 最大被试数 (用于测试, 0 或 null 表示处理所有)
  max_subjects: 0
  
  # Atlas配置
  atlas:
    name: "schaefer200"
    file: "atlases/Schaefer2018_200Parcels_7Networks_order_FSLMNI152_2mm.nii.gz"
    label_file: "atlases/schaefer200_mask_ready.json"

  # 图缓存配置
  # 每个 (被试, 任务) 的异质图构建完成后自动保存为 .pt 文件。
  # 再次运行时直接加载，无需重新预处理，节省数分钟到数十分钟。
  # 缓存文件名包含配置哈希，修改图参数后自动失效并重建。
  cache:
    enabled: true
    dir: "outputs/graph_cache"

# Model configuration
model:
  # Model type: "graph_native" or "v5_optimized"
  type: "v5_optimized"
  
  # Hidden layer dimension
  hidden_channels: 128
  
  # Number of encoder layers
  num_encoder_layers: 4
  
  # Number of decoder layers
  num_decoder_layers: 3
  
  # Enable prediction
  use_prediction: true
  
  # Prediction steps
  prediction_steps: 10
  
  # Dropout rate
  dropout: 0.1
  
  # Loss function type (mse, huber, smooth_l1)
  # huber: robust to outliers, 5-10% better on noisy signals
  loss_type: "huber"

# Training configuration
training:
  # 训练轮数
  num_epochs: 100
  
  # 批次大小
  batch_size: 1
  
  # 学习率
  learning_rate: 0.0001
  
  # 权重衰减
  weight_decay: 0.00001
  
  # Use adaptive loss balancing
  use_adaptive_loss: true
  
  # Use EEG enhancement
  use_eeg_enhancement: true
  
  # Use gradient checkpointing (saves memory, required for long sequences)
  # Trades recomputation for memory: frees per-timestep activations in the
  # ST-GCN temporal loop so they don't accumulate and exhaust RAM.
  use_gradient_checkpointing: true

  # Maximum sequence length per modality (timepoints).
  # ─────────────────────────────────────────────────────────────
  # 【单样本训练模式 (windowed_sampling.enabled: false)】
  #   截断到此长度再构建图。防止 CUDA OOM。
  #   经验值: 300 适合 8 GB GPU; 600 适合 16 GB GPU。
  # 【时间窗口模式 (windowed_sampling.enabled: true)】
  #   此参数不生效（图构建使用完整序列，训练样本长度由 window_size 控制）。
  #   建议设为 null 以使用完整 run 估计连通性。
  max_seq_len: 300
  
  # Use learning rate scheduler (10-20% faster convergence)
  use_scheduler: true
  scheduler_type: "cosine"  # Options: cosine, onecycle, plateau
  
  # Gradient clipping
  max_grad_norm: 1.0
  
  # Validation frequency (every N epochs)
  val_frequency: 5
  
  # Save checkpoint frequency
  save_frequency: 10
  
  # Early stopping patience
  early_stopping_patience: 20

# ── 时间窗口采样（动态功能连接 dFC 范式）────────────────────────────
# 将每条完整扫描（run）切分为多个重叠时间窗口。
#
# 科学依据（Hutchison 2013; Chang & Glover 2010）：
#   • 图拓扑（edge_index）= 完整 run 的相关性 → 稳定的结构连通性
#   • 节点特征（x）= 窗口切片 → 每窗口 = 一个脑状态快照 = 一个训练样本
#   • 多窗口 × 多被试 × 多任务 = 充足训练数据（n_subjects×n_tasks×n_windows）
#
# 与朴素截断（max_seq_len）的关键区别：
#   截断 → 丢弃数据，1 样本/run，EEG 连通性估计仅 1.2s（统计不可靠）
#   窗口 → 利用全部数据，N 样本/run，连通性来自完整 run（稳定可靠）
#
# 推荐配置（启用时将 max_seq_len 设为 null）：
#   fmri_window_size: 50   → 50 TRs × TR=2s = 100s ≈ 一个静息脑状态周期
#   eeg_window_size: 500   → 500pts ÷ 250Hz = 2s（覆盖 alpha/beta/gamma 节律）
#   stride_fraction: 0.5   → 50% 重叠 → 约 2× 更多样本（标准 dFC 设置）
windowed_sampling:
  enabled: false          # true = dFC 窗口模式（推荐研究使用）
                          # false = 单样本模式（与旧版本行为相同）
  fmri_window_size: 50    # fMRI 每个窗口的 TR 数（建议 30-100）
  eeg_window_size: 500    # EEG 每个窗口的采样点数（建议 250-2000）
  stride_fraction: 0.5    # 步长 = window_size × stride_fraction（0.5 = 50% 重叠）

# V5优化配置
v5_optimization:
  # 自适应损失平衡
  adaptive_loss:
    alpha: 1.5
    learning_rate: 0.025
    update_frequency: 10
    warmup_epochs: 5
    modality_energy_ratios:
      eeg: 0.02
      fmri: 1.0
  
  # EEG通道增强
  eeg_enhancement:
    enable_monitoring: true
    enable_dropout: true
    enable_attention: true
    enable_regularization: true
    dropout_rate: 0.1
    attention_hidden_dim: 64
    entropy_weight: 0.01
    diversity_weight: 0.01
    activity_weight: 0.01
  
  # 高级预测
  advanced_prediction:
    use_hierarchical: true
    use_transformer: true
    use_uncertainty: true
    num_scales: 3
    num_windows: 3
    sampling_strategy: "uniform"

# 图配置
graph:
  # fMRI连接性阈值
  threshold_fmri: 0.3
  
  # EEG连接性阈值
  threshold_eeg: 0.2
  
  # fMRI K近邻 (小世界网络)
  k_nearest_fmri: 20
  
  # EEG K近邻 (更局部的连接)
  k_nearest_eeg: 10
  
  # 是否添加自环
  add_self_loops: true
  
  # 是否无向图
  make_undirected: true
  
  # 跨模态边距离阈值 (mm)
  cross_modal_distance_threshold: 30.0

# 输出配置
output:
  # 输出目录
  output_dir: "outputs"
  
  # 实验名称
  experiment_name: "twinbrain_v5"
  
  # 是否保存图结构
  save_graphs: true
  
  # 是否保存预测结果
  save_predictions: true
  
  # 日志级别
  log_level: "INFO"

# Device configuration
device:
  # Device type: "cuda", "cpu", or "cuda:0"
  type: "cuda"
  
  # GPU memory configuration (8GB, 12GB, 16GB)
  gpu_memory: "8GB"
  
  # Use mixed precision (AMP)
  use_amp: True
  
  # Use torch.compile() for 20-40% speedup (PyTorch 2.0+, Linux/macOS only).
  # Requires Triton which is NOT available on Windows. Set to True only if you
  # have confirmed that `import triton` succeeds in your environment.
  use_torch_compile: False
  compile_mode: "reduce-overhead"  # Options: default, reduce-overhead, max-autotune
