# TwinBrain V5 - 快速开始指南

## 一、简介

**TwinBrain V5** 是一个图原生的数字孪生脑训练系统。

### 核心特点

- ✅ **图原生架构** - 从数据到训练全程保持图结构
- ✅ **时空图卷积** - 同时建模空间和时间信息
- ✅ **开箱即用** - 配置数据路径即可运行
- ✅ **完整流程** - 数据加载、预处理、训练一体化

---

## 二、快速开始

### 1. 安装依赖

```bash
pip install torch torch-geometric nibabel mne pyyaml numpy scipy
```

### 2. 配置数据路径

编辑 `configs/default.yaml`:

```yaml
data:
  # 修改为你的数据目录
  root_dir: "/path/to/your/brain/data"
  
  # 选择要处理的模态
  modalities: ["eeg", "fmri"]
```

### 3. 运行训练

```bash
python main.py
```

就这么简单！系统会自动：
1. 加载数据
2. 构建图结构
3. 创建模型
4. 开始训练

---

## 三、项目结构

```
train_v5_optimized/
├── main.py                    # 主程序入口 ⭐
├── configs/                   # 配置文件
│   └── default.yaml          # 默认配置 ⭐
├── data/                      # 数据处理
│   ├── loaders.py            # 数据加载器
│   ├── eeg_preprocessor.py   # EEG预处理
│   └── fmri_preprocessor.py  # fMRI预处理
├── models/                    # 模型定义
│   ├── graph_native_mapper.py   # 图映射器
│   ├── graph_native_encoder.py  # 图编码器
│   └── graph_native_system.py   # 完整系统
├── core/                      # 核心优化
│   ├── adaptive_loss_balancer.py
│   ├── eeg_channel_handler.py
│   └── advanced_prediction.py
├── utils/                     # 工具函数
│   └── helpers.py
└── docs/                      # 文档
    ├── 快速开始.md           # 本文件 ⭐
    ├── 更新日志.md           # 更新记录 ⭐
    └── 架构分析.md           # 架构说明 ⭐
```

---

## 四、配置说明

### 关键配置项

**1. 数据配置** (`configs/default.yaml`)

```yaml
data:
  root_dir: "/path/to/data"      # 数据根目录
  modalities: ["eeg", "fmri"]    # 要处理的模态
  task: null                      # 任务名称 (可选)
  max_subjects: null              # 最大被试数 (null=全部)
```

**2. 模型配置**

```yaml
model:
  type: "graph_native"           # 使用图原生模型
  hidden_channels: 128           # 隐藏层维度
  num_encoder_layers: 4          # 编码器层数
  use_prediction: true           # 启用预测
  prediction_steps: 10           # 预测步数
```

**3. 训练配置**

```yaml
training:
  num_epochs: 100                # 训练轮数
  learning_rate: 0.0001          # 学习率
  use_adaptive_loss: true        # 自适应损失平衡
  use_eeg_enhancement: true      # EEG增强
```

---

## 五、使用示例

### 示例1: 基础训练

```bash
# 使用默认配置训练
python main.py
```

### 示例2: 指定配置文件

```bash
# 使用自定义配置
python main.py --config configs/my_config.yaml
```

### 示例3: 设置随机种子

```bash
# 指定随机种子确保可重复
python main.py --seed 123
```

### 示例4: 只处理部分被试 (测试)

修改配置文件:
```yaml
data:
  max_subjects: 5  # 只处理5个被试
```

然后运行:
```bash
python main.py
```

---

## 六、输出说明

训练完成后，在 `outputs/` 目录下会生成:

```
outputs/
└── twinbrain_v5_20240213_120000/     # 时间戳命名的实验目录
    ├── checkpoints/                   # 模型检查点
    │   ├── best_model.pt             # 最佳模型
    │   └── checkpoint_epoch_XX.pt    # 定期检查点
    ├── logs/
    │   └── training.log              # 训练日志
    ├── results/                       # 结果文件
    └── config.yaml                    # 保存的配置
```

---

## 七、常见问题

### Q1: 数据格式要求？

**A:** 支持标准BIDS格式的脑影像数据:
- EEG: `.set` 格式 (EEGLAB)
- fMRI: `.nii` 或 `.nii.gz` 格式 (NIfTI)

### Q2: 内存不足怎么办？

**A:** 修改配置降低内存使用:

```yaml
model:
  hidden_channels: 64        # 降低维度 (默认128)
  num_encoder_layers: 2      # 减少层数 (默认4)

data:
  max_subjects: 10           # 减少被试数
```

### Q3: GPU显存不够？

**A:** 根据GPU调整配置:

```yaml
device:
  gpu_memory: "8GB"          # 8GB GPU配置
  
model:
  hidden_channels: 96        # 适当降低
  
v5_optimization:
  advanced_prediction:
    num_windows: 2           # 减少窗口数
```

### Q4: 如何恢复训练？

**A:** 暂不支持自动恢复，计划在下个版本添加。

### Q5: 训练速度慢？

**A:** 启用混合精度训练:

```yaml
device:
  use_amp: true              # 启用自动混合精度
```

---

## 八、下一步

1. **查看更新日志** - `docs/更新日志.md` 了解所有改进
2. **理解架构** - `docs/架构分析.md` 深入了解设计
3. **调整配置** - 根据你的数据调整 `configs/default.yaml`
4. **开始训练** - `python main.py`

---

## 九、获取帮助

查看帮助信息:
```bash
python main.py --help
```

查看训练日志:
```bash
tail -f outputs/[your_experiment]/logs/training.log
```

---

**版本**: V5.0  
**更新时间**: 2024-02-14  
**状态**: 生产就绪
